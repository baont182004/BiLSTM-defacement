<!DOCTYPE html>
<html lang="vi">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>{{ app_name }} - Ph√°t hi·ªán Defacement</title>
        <link rel="stylesheet"
            href="{{ url_for('static', filename='style.css') }}">
        <link rel="icon"
            href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üõ°Ô∏è</text></svg>">
    </head>
    <body>
        <div class="container">
            <h1 class="logo">{{ app_name }}</h1>
            <h2>Tr√¨nh ph√°t hi·ªán Website Deface d·ª±a tr√™n BiLSTM</h2>

            <div class="input-group">
                <input type="url" id="url-input"
                    placeholder="Nh·∫≠p URL trang web c·∫ßn ki·ªÉm tra..." required>
                <button id="predict-button" onclick="checkUrl()">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16"
                        height="16" fill="currentColor"
                        class="bi bi-shield-check" viewBox="0 0 16 16">
                        <path
                            d="M5.338 1.59a61 61 0 0 0-2.837.856.48.48 0 0 0-.328.39c-.554 4.157.726 7.19 2.253 9.188a10.7 10.7 0 0 0 2.287 2.233c.346.244.652.42.893.533q.18.085.293.118a1 1 0 0 0 .101.025 1 1 0 0 0 .1-.025q.114-.034.294-.118c.24-.113.547-.29.893-.533a10.7 10.7 0 0 0 2.287-2.233c1.527-1.997 2.807-5.031 2.253-9.188a.48.48 0 0 0-.328-.39c-.651-.213-1.75-.56-2.837-.855C9.552 1.29 8.531 1.067 8 1.067c-.53 0-1.552.223-2.662.524zM14 1.796c.822.263 1.987.645 2.584 1.099a.63.63 0 0 1 .342.53c.69 5.25-1.067 8.615-2.873 10.855a11.7 11.7 0 0 1-2.582 2.526C9.15 15.82 8.558 16 8 16s-1.15-.18-1.973-.429A11.7 11.7 0 0 1 3.447 13.28c-1.806-2.24-3.563-5.604-2.873-10.855a.63.63 0 0 1 .342-.53C1.53 2.44 2.695 2.058 3.517 1.796 4.773 1.38 6.113 1.007 8 1.007c1.887 0 3.227.373 4.483.789" />
                        <path
                            d="M10.854 5.146a.5.5 0 0 1 0 .708l-3 3a.5.5 0 0 1-.708 0l-1.5-1.5a.5.5 0 1 1 .708-.708L7.5 7.793l2.646-2.647a.5.5 0 0 1 .708 0" />
                    </svg>
                    Ki·ªÉm tra
                </button>
            </div>

            <div id="loader" class="loader" style="display: none;"></div>

            <div id="result-container" class="result-wrapper"
                style="display: none;">
                <div class="result-main">
                    <h3>K·∫øt qu·∫£ Ph√¢n t√≠ch</h3>
                    <span id="result-status"></span>
                    <p>X√°c su·∫•t Deface: <span id="result-prob"></span>%</p>
                    <p class="url-checked">URL ƒë√£ ki·ªÉm tra: <strong
                            id="result-url"></strong></p>
                    <p class="source-info">Ngu·ªìn d·ªØ li·ªáu: <strong
                            id="result-source"></strong></p>
                    <div class="timing-info">
                        <span>Th·ªùi gian c√†o: <strong id="scrape-time"></strong>
                            ms</span> |
                        <span>Th·ªùi gian d·ª± ƒëo√°n: <strong
                                id="predict-time"></strong> ms</span>
                    </div>
                </div>
                <div class="result-details">
                    <h4>VƒÉn b·∫£n thu·∫ßn ƒë∆∞·ª£c tr√≠ch xu·∫•t</h4>
                    <pre id="result-text"></pre>
                </div>
            </div>

            <div id="error-message" class="error-box"
                style="display: none;"></div>

        </div>

        <script>
        async function checkUrl() {
            const urlInput = document.getElementById('url-input');
            const url = urlInput.value.trim(); 
            const button = document.getElementById('predict-button');
            const loader = document.getElementById('loader');
            const resultContainer = document.getElementById('result-container');
            const errorMessage = document.getElementById('error-message');

            const resultStatus = document.getElementById('result-status');
            const resultProb = document.getElementById('result-prob');
            const resultUrl = document.getElementById('result-url');
            const resultSource = document.getElementById('result-source');
            const resultText = document.getElementById('result-text');
            const scrapeTime = document.getElementById('scrape-time');
            const predictTime = document.getElementById('predict-time');

            // Ki·ªÉm tra URL h·ª£p l·ªá c∆° b·∫£n
            if (!url || !url.startsWith('http')) {
                 errorMessage.innerText = "L·ªói: Vui l√≤ng nh·∫≠p URL h·ª£p l·ªá (b·∫Øt ƒë·∫ßu b·∫±ng http:// ho·∫∑c https://)";
                 errorMessage.style.display = 'block';
                 resultContainer.style.display = 'none'; 
                 return;
            }

            // Reset tr·∫°ng th√°i
            button.disabled = true; 
            button.innerHTML = '<span class="spinner"></span> ƒêang ki·ªÉm tra...'; 
            loader.style.display = 'none'; 
            resultContainer.style.display = 'none';
            errorMessage.style.display = 'none'; 
            resultStatus.className = '';

            try {
                const response = await fetch('/predict', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ url: url }),
                });

                const data = await response.json();

                if (!response.ok) {
                    errorMessage.innerText = `L·ªói ${response.status}: ${data.error || 'Kh√¥ng r√µ nguy√™n nh√¢n t·ª´ m√°y ch·ªß.'}`;
                    errorMessage.style.display = 'block';
                    resultContainer.style.display = 'none';
                } else {
                    resultStatus.innerText = data.status;
                    resultProb.innerText = (data.probability * 100).toFixed(2);
                    resultUrl.innerText = data.checked_url;
                    resultSource.innerText = data.source;
                    resultText.innerText = data.extracted_text || '(Trang kh√¥ng c√≥ vƒÉn b·∫£n)';
                    scrapeTime.innerText = data.scrape_time_ms;
                    predictTime.innerText = data.predict_time_ms;

                    resultStatus.className = data.status === 'T·∫•n c√¥ng Deface' ? 'status-defaced' : 'status-safe';
                    resultContainer.style.display = 'flex';
                }

            } catch (error) {
                errorMessage.innerText = `L·ªói k·∫øt n·ªëi m·∫°ng ho·∫∑c m√°y ch·ªß kh√¥ng ph·∫£n h·ªìi: ${error.message}`;
                errorMessage.style.display = 'block';
                resultContainer.style.display = 'none';
            } finally {
                button.disabled = false;
                button.innerHTML = `
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-shield-check" viewBox="0 0 16 16">
                      <path d="M5.338 1.59a61 61 0 0 0-2.837.856.48.48 0 0 0-.328.39c-.554 4.157.726 7.19 2.253 9.188a10.7 10.7 0 0 0 2.287 2.233c.346.244.652.42.893.533q.18.085.293.118a1 1 0 0 0 .101.025 1 1 0 0 0 .1-.025q.114-.034.294-.118c.24-.113.547-.29.893-.533a10.7 10.7 0 0 0 2.287-2.233c1.527-1.997 2.807-5.031 2.253-9.188a.48.48 0 0 0-.328-.39c-.651-.213-1.75-.56-2.837-.855C9.552 1.29 8.531 1.067 8 1.067c-.53 0-1.552.223-2.662.524zM14 1.796c.822.263 1.987.645 2.584 1.099a.63.63 0 0 1 .342.53c.69 5.25-1.067 8.615-2.873 10.855a11.7 11.7 0 0 1-2.582 2.526C9.15 15.82 8.558 16 8 16s-1.15-.18-1.973-.429A11.7 11.7 0 0 1 3.447 13.28c-1.806-2.24-3.563-5.604-2.873-10.855a.63.63 0 0 1 .342-.53C1.53 2.44 2.695 2.058 3.517 1.796 4.773 1.38 6.113 1.007 8 1.007c1.887 0 3.227.373 4.483.789"/>
                      <path d="M10.854 5.146a.5.5 0 0 1 0 .708l-3 3a.5.5 0 0 1-.708 0l-1.5-1.5a.5.5 0 1 1 .708-.708L7.5 7.793l2.646-2.647a.5.5 0 0 1 .708 0"/>
                    </svg>
                    Ki·ªÉm tra`;
            }
        }
    </script>
    </body>
</html>